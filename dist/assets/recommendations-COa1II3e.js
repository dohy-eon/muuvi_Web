import{s as l}from"./index-BREGoMZi.js";const I={"01":["로맨스"],"02":["공포","스릴러"],"03":["코미디"],"04":["SF"],"05":["판타지"],"06":["모험"],"07":["액션"],"08":["드라마","가족"],"09":["미스터리","스릴러"]};function h(e){const t=new Set;return e.forEach(n=>{(I[n]||[]).forEach(s=>t.add(s))}),Array.from(t)}const u={},f=typeof Deno<"u";async function E(){var o,g;let e="",t="";f?(e=Deno.env.get("SUPABASE_ANON_KEY")||Deno.env.get("VITE_SUPABASE_ANON_KEY")||"",t=Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")||Deno.env.get("VITE_SUPABASE_SERVICE_ROLE_KEY")||""):typeof import.meta<"u"&&(e="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRudWlzdnp3ZmZ3cnpxY2RjY3poIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyMzIzMzgsImV4cCI6MjA3NzgwODMzOH0.14yk-eK30HLWpopxR2cfYNPdh3Ii4B1xgjXvY9uov9Y",t=(u==null?void 0:u.VITE_SUPABASE_SERVICE_ROLE_KEY)||"");const n=await l.auth.getSession().catch(()=>null),c=(g=(o=n==null?void 0:n.data)==null?void 0:o.session)==null?void 0:g.access_token,s={},i=c||t||e;return e&&(s.apikey=e),i&&(s.Authorization=`Bearer ${i}`),s}const y={"01":"로맨스","02":"호러","03":"코미디","04":"공상 과학","05":"판타지","06":"어드벤처","07":"액션","08":"힐링","09":"미스테리"};async function A(e,t=!1){try{const c=`${e.moods.map(i=>y[i]||"").join(" ")} ${e.genre}`,s=h(e.moods);try{console.log(`[AI 추천 시도] "${c}"`);const{data:i,error:o}=await l.functions.invoke("embed",{body:{text:c}});if(o)throw console.warn("[임베딩 실패] 태그 검색으로 폴백:",o.message),o;const g=i.vector,{data:m,error:d}=await l.rpc("match_contents",{query_vector:g,match_count:10,p_genre:e.genre,p_mood_tags:s});if(d)throw console.warn("[벡터 검색 실패] 태그 검색으로 폴백:",d.message),d;const r=(m||[]).filter(a=>a.ott_providers&&a.ott_providers.length>0);if(r.length>0)return console.log(`[AI 추천 성공] "${c}" => ${r.length}개 반환`),r.slice(0,10);throw console.log("[AI 추천 결과 없음] 태그 검색으로 폴백"),new Error("No AI results")}catch{console.log(`[태그 기반 검색] "${c}"`);let o=l.from("contents").select("*");o=o.not("ott_providers","is",null),e.genre&&(o=o.eq("genre",e.genre)),s.length>0&&(o=o.overlaps("tags",s));const{data:g,error:m}=await o.order("imdb_rating",{ascending:!1,nullsFirst:!1}).limit(30);if(m)return console.error("[태그 검색 실패]:",m),[];const d=(g||[]).filter(r=>r.ott_providers&&r.ott_providers.length>0);if(console.log(`[태그 추천 성공] "${c}" => ${d.length}개 반환`),d.length===0){const r=e.moods[0];if(e.genre&&r)try{console.log(`[데이터 보충 요청] ${e.genre} + ${r}`);const a=await E();await l.functions.invoke("populate-db",{body:{genre:e.genre,mood:r},headers:a})}catch(a){console.warn("[데이터 보충 실패]",(a==null?void 0:a.message)||a)}}return d.slice(0,10)}}catch(n){return console.error("추천 조회 실패:",n),[]}}async function S(e){try{const{data:t,error:n}=await l.from("contents").select("*").eq("id",e).single();return n?(console.error("콘텐츠 조회 실패:",n),null):t}catch(t){return console.error("콘텐츠 조회 중 오류:",t),null}}export{S as a,A as g};
